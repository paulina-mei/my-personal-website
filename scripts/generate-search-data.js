#!/usr/bin/env node

/**
 * Search Data Generator
 *
 * Automatically generates js/writing-search.js from article HTML files.
 * This eliminates content duplication - articles are the single source of truth.
 *
 * Usage: node generate-search-data.js
 *
 * Run this after:
 * - Adding new articles
 * - Updating article content
 * - Changing article titles/descriptions
 */

const fs = require('fs');
const path = require('path');

// Paths
const articlesDir = path.join(__dirname, '..', 'articles');
const outputFile = path.join(__dirname, '..', 'js', 'writing-search.js');

/**
 * Extract text content from HTML, removing all tags
 */
function stripHtml(html) {
    return html
        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '') // Remove scripts
        .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')   // Remove styles
        .replace(/<[^>]+>/g, ' ')                         // Remove tags
        .replace(/\s+/g, ' ')                             // Normalize whitespace
        .trim();
}

/**
 * Extract value from meta tag
 */
function extractMetaTag(html, property) {
    const regex = new RegExp(`<meta\\s+(?:property|name)=["']${property}["']\\s+content=["']([^"']*)["']`, 'i');
    const match = html.match(regex);
    return match ? match[1] : '';
}

/**
 * Extract article data from HTML file
 */
function parseArticleFile(filepath) {
    const html = fs.readFileSync(filepath, 'utf8');
    const filename = path.basename(filepath);

    // Extract title from <title> tag or <h1>
    let title = '';
    const titleMatch = html.match(/<title>([^<]+)</i);
    if (titleMatch) {
        title = titleMatch[1].replace(' | Paulina Mei', '').trim();
    } else {
        const h1Match = html.match(/<h1[^>]*>([^<]+)</i);
        if (h1Match) title = h1Match[1].trim();
    }

    // Extract description from meta tag
    const description = extractMetaTag(html, 'description') ||
                       extractMetaTag(html, 'og:description') || '';

    // Extract date from <time datetime> tag
    let date = '';
    const timeMatch = html.match(/<time[^>]*datetime=["']([^"']+)["']/i);
    if (timeMatch) {
        date = timeMatch[1].split('T')[0]; // Get YYYY-MM-DD part
    }

    // Extract article content
    let content = '';
    const contentMatch = html.match(/<div class="article-content">([\s\S]*?)<\/div>/i);
    if (contentMatch) {
        content = stripHtml(contentMatch[1]);
    } else {
        // Fallback: extract all text between <article> tags
        const articleMatch = html.match(/<article[^>]*>([\s\S]*?)<\/article>/i);
        if (articleMatch) {
            content = stripHtml(articleMatch[1]);
        }
    }

    // Limit content length for search (first 500 chars)
    const searchContent = content.substring(0, 500);

    return {
        title,
        description,
        content: searchContent,
        url: `articles/${filename}`,
        date
    };
}

/**
 * Generate writing-search.js file
 */
function generateSearchFile(articles) {
    const header = `/**
 * Article Search Data
 *
 * Auto-generated by generate-search-data.js
 * DO NOT EDIT THIS FILE MANUALLY
 *
 * To update this file:
 * 1. Edit article HTML files in /articles/
 * 2. Run: node scripts/generate-search-data.js
 *
 * Articles are automatically sorted by date (newest first)
 */

`;

    const articlesJson = JSON.stringify(articles, null, 4);

    const fileContent = header + `const allArticles = ${articlesJson};\n\n` +
`// Format date to readable format (e.g., "Oct 2025")
function formatDate(isoDate) {
    const date = new Date(isoDate);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    return \`\${months[date.getMonth()]} \${date.getFullYear()}\`;
}

// Export for use in other scripts (if needed)
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { allArticles, formatDate };
}
`;

    return fileContent;
}

/**
 * Main function
 */
function main() {
    console.log('\nüîç Search Data Generator\n');

    try {
        // Check if articles directory exists
        if (!fs.existsSync(articlesDir)) {
            console.error('‚ùå Error: articles/ directory not found');
            process.exit(1);
        }

        // Read all HTML files from articles directory
        const files = fs.readdirSync(articlesDir)
            .filter(file => file.endsWith('.html'))
            .map(file => path.join(articlesDir, file));

        if (files.length === 0) {
            console.warn('‚ö†Ô∏è  Warning: No article files found in articles/');
            console.log('Creating empty search data file...\n');
        }

        console.log(`Found ${files.length} article(s):\n`);

        // Parse each article
        const articles = files.map(file => {
            const article = parseArticleFile(file);
            console.log(`  ‚úì ${article.title}`);
            console.log(`    Date: ${article.date}`);
            console.log(`    URL: ${article.url}\n`);
            return article;
        });

        // Sort by date (newest first)
        articles.sort((a, b) => {
            const dateA = new Date(a.date);
            const dateB = new Date(b.date);
            return dateB - dateA; // Descending order
        });

        // Generate the search file
        const fileContent = generateSearchFile(articles);
        fs.writeFileSync(outputFile, fileContent);

        console.log(`‚úÖ Generated: js/writing-search.js`);
        console.log(`\nüìä Summary:`);
        console.log(`   - ${articles.length} article(s) processed`);
        console.log(`   - Sorted by date (newest first)`);
        console.log(`   - Ready for search functionality\n`);

        console.log('üí° Next steps:');
        console.log('   1. Test your website locally');
        console.log('   2. Verify search works on writing.html');
        console.log('   3. Check homepage shows correct articles\n');

    } catch (error) {
        console.error('‚ùå Error:', error.message);
        console.error(error.stack);
        process.exit(1);
    }
}

main();
